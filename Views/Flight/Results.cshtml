@model MoteurDeRechercheDeVol.ViewModels.FlightResultsViewModel

@{
    ViewData["Title"] = "Flight Results";
}

<div class="container mt-4">
    <!-- Search Summary & Modify Button -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-2">
                        <i class="fas fa-plane-departure"></i> @Model.SearchCriteria.DepartureCity 
                        <i class="fas fa-arrow-right mx-2"></i> 
                        <i class="fas fa-plane-arrival"></i> @Model.SearchCriteria.ArrivalCity
                    </h5>
                    <p class="mb-0 text-muted">
                        @Model.SearchCriteria.DepartureDate.ToString("MMM dd, yyyy")
                        @if (Model.SearchCriteria.ReturnDate.HasValue && Model.SearchCriteria.TripType == "round-trip")
                        {
                            <span> - @Model.SearchCriteria.ReturnDate.Value.ToString("MMM dd, yyyy")</span>
                        }
                        | @Model.SearchCriteria.NumberOfPassengers Passenger(s) | @Model.SearchCriteria.ClassType
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a asp-action="ModifySearch" 
                       asp-route-searchData="@Newtonsoft.Json.JsonConvert.SerializeObject(Model.SearchCriteria)" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Modify Search
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-filter"></i> Filters & Sort</h6>
                </div>
                <div class="card-body">
                    <form asp-action="FilterAndSort" method="post">
                        <!-- Sort Options -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Sort By</label>
                            <select name="sortBy" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Best Match</option>
                                <option value="price-asc" selected="@(Model.AppliedFilters?.SortBy == "price-asc")">
                                    Price: Low to High
                                </option>
                                <option value="price-desc" selected="@(Model.AppliedFilters?.SortBy == "price-desc")">
                                    Price: High to Low
                                </option>
                                <option value="duration-asc" selected="@(Model.AppliedFilters?.SortBy == "duration-asc")">
                                    Duration: Shortest
                                </option>
                                <option value="duration-desc" selected="@(Model.AppliedFilters?.SortBy == "duration-desc")">
                                    Duration: Longest
                                </option>
                                <option value="stops-asc" selected="@(Model.AppliedFilters?.SortBy == "stops-asc")">
                                    Fewest Stops
                                </option>
                            </select>
                        </div>

                        <hr />

                        <!-- Stops Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Stops</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="directOnly" 
                                       id="directOnly" value="true" 
                                       checked="@(Model.AppliedFilters?.DirectOnly == true)"
                                       onchange="this.form.submit()">
                                <label class="form-check-label" for="directOnly">
                                    Direct flights only
                                </label>
                            </div>
                        </div>

                        <hr />

                        <!-- Departure Time Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Departure Time</label>
                            <select name="departureTime" class="form-select form-select-sm" 
                                    onchange="this.form.submit()">
                                <option value="">Any time</option>
                                <option value="morning" selected="@(Model.AppliedFilters?.DepartureTime == "morning")">
                                    Morning (6AM - 12PM)
                                </option>
                                <option value="afternoon" selected="@(Model.AppliedFilters?.DepartureTime == "afternoon")">
                                    Afternoon (12PM - 6PM)
                                </option>
                                <option value="evening" selected="@(Model.AppliedFilters?.DepartureTime == "evening")">
                                    Evening (6PM - 6AM)
                                </option>
                            </select>
                        </div>

                        <!-- Arrival Time Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Arrival Time</label>
                            <select name="arrivalTime" class="form-select form-select-sm" 
                                    onchange="this.form.submit()">
                                <option value="">Any time</option>
                                <option value="morning" selected="@(Model.AppliedFilters?.ArrivalTime == "morning")">
                                    Morning (6AM - 12PM)
                                </option>
                                <option value="afternoon" selected="@(Model.AppliedFilters?.ArrivalTime == "afternoon")">
                                    Afternoon (12PM - 6PM)
                                </option>
                                <option value="evening" selected="@(Model.AppliedFilters?.ArrivalTime == "evening")">
                                    Evening (6PM - 6AM)
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results List -->
        <div class="col-lg-9">
            <div class="mb-3">
                <h5>@Model.TotalResults flights found</h5>
            </div>

            @if (Model.FlightOffers == null || !Model.FlightOffers.Any())
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No flights found matching your criteria. 
                    Try adjusting your filters.
                </div>
            }
            else
            {
                @foreach (var flight in Model.FlightOffers)
                {
                    <div class="card mb-3 shadow-sm flight-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Outbound Flight Info -->
                                <div class="col-md-8">
                                    <div class="mb-2">
                                        <span class="badge bg-primary">Outbound</span>
                                        @if (flight.NumberOfStops == 0)
                                        {
                                            <span class="badge bg-success">Direct</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">
                                                @flight.NumberOfStops @(flight.NumberOfStops == 1 ? "Stop" : "Stops")
                                            </span>
                                        }
                                    </div>

                                    @foreach (var segment in flight.OutboundSegments)
                                    {
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-grow-1">
                                                <div class="row">
                                                    <div class="col-3">
                                                        <div class="fw-bold">@segment.DepartureTime.ToString("HH:mm")</div>
                                                        <div class="text-muted small">@segment.DepartureAirport</div>
                                                    </div>
                                                    <div class="col-6 text-center">
                                                        <div class="text-muted small">
                                                            @segment.Duration.ToString(@"h\h\ m\m")
                                                        </div>
                                                        <div>
                                                            <i class="fas fa-long-arrow-alt-right"></i>
                                                        </div>
                                                        <div class="text-muted small">@segment.AirlineName</div>
                                                    </div>
                                                    <div class="col-3 text-end">
                                                        <div class="fw-bold">@segment.ArrivalTime.ToString("HH:mm")</div>
                                                        <div class="text-muted small">@segment.ArrivalAirport</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    <!-- Return Flight Info -->
                                    @if (flight.ReturnSegments != null && flight.ReturnSegments.Any())
                                    {
                                        <hr />
                                        <div class="mb-2">
                                            <span class="badge bg-info">Return</span>
                                        </div>

                                        @foreach (var segment in flight.ReturnSegments)
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="flex-grow-1">
                                                    <div class="row">
                                                        <div class="col-3">
                                                            <div class="fw-bold">@segment.DepartureTime.ToString("HH:mm")</div>
                                                            <div class="text-muted small">@segment.DepartureAirport</div>
                                                        </div>
                                                        <div class="col-6 text-center">
                                                            <div class="text-muted small">
                                                                @segment.Duration.ToString(@"h\h\ m\m")
                                                            </div>
                                                            <div>
                                                                <i class="fas fa-long-arrow-alt-right"></i>
                                                            </div>
                                                            <div class="text-muted small">@segment.AirlineName</div>
                                                        </div>
                                                        <div class="col-3 text-end">
                                                            <div class="fw-bold">@segment.ArrivalTime.ToString("HH:mm")</div>
                                                            <div class="text-muted small">@segment.ArrivalAirport</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>

                                <!-- Price & Book -->
                                <div class="col-md-4 text-center border-start">
                                    <div class="h3 text-primary mb-2">
                                        @flight.Currency @flight.Price.ToString("N2")
                                    </div>
                                    <div class="text-muted small mb-3">
                                        Total for @Model.SearchCriteria.NumberOfPassengers passenger(s)
                                    </div>

                                    <div class="mt-2">
                                        <small class="text-muted">
                                            Total Duration: @flight.TotalDuration.ToString(@"h\h\ m\m")
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Keep TempData alive for page refresh
        $.post('@Url.Action("KeepTempData", "Flight")');
    </script>
}
